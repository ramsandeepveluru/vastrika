<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Vastrika</title>
  <style>
    body {
      font-family: Arial;
      padding: 30px;
      background: #f5f5f5;
    }

    h1 {
      margin-bottom: 20px;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }

    button {
      padding: 8px 12px;
      background: black;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }

    button:hover {
      background: #333;
    }

    .item-box {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background: #fafafa;
    }

    img.product-img {
      width: 100px;
      margin-top: 5px;
    }

    #preview {
      display: none;
      width: 150px;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>

<h1>ðŸ“Š Admin Panel</h1>

<!-- ================= ADD PRODUCT ================= -->

<div class="section">
  <h2>âž• Add Product</h2>

  <form id="productForm">
    <input type="text" id="name" placeholder="Product Name" required>
    <input type="number" id="price" placeholder="Price" required>
    <input type="text" id="category" placeholder="Category" required>
    <textarea id="description" placeholder="Description" required></textarea>
    <input type="number" id="stock" placeholder="Stock" required>
    <input type="file" id="image" accept="image/*" required>

    <img id="preview">

    <button type="submit">Add Product</button>
  </form>
</div>

<!-- ================= PRODUCTS LIST ================= -->

<div class="section">
  <h2>ðŸ“¦ Manage Products</h2>
  <div id="products"></div>
</div>

<!-- ================= ORDERS LIST ================= -->

<div class="section">
  <h2>ðŸ“‘ Manage Orders</h2>
  <div id="orders"></div>
</div>

<script>

const token = localStorage.getItem("token");

// ðŸ” Protect Admin Page
if (!token) {
  alert("Please login first");
  window.location.href = "/login.html";
}

// ================= IMAGE PREVIEW =================

document.getElementById("image").addEventListener("change", function(event) {
  const file = event.target.files[0];
  const preview = document.getElementById("preview");

  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

// ================= ADD PRODUCT =================

document.getElementById("productForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append("name", document.getElementById("name").value);
  formData.append("price", document.getElementById("price").value);
  formData.append("category", document.getElementById("category").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("stock", document.getElementById("stock").value);
  formData.append("image", document.getElementById("image").files[0]);

  const res = await fetch("/api/admin/products", {
    method: "POST",
    headers: {
      "Authorization": token
    },
    body: formData
  });

  const data = await res.json();
  alert(data.message);

  document.getElementById("productForm").reset();
  document.getElementById("preview").style.display = "none";

  loadProducts();
});

// ================= LOAD PRODUCTS =================

async function loadProducts() {
  const res = await fetch("/api/products");
  const products = await res.json();

  const container = document.getElementById("products");
  container.innerHTML = "";

  products.forEach(p => {
    container.innerHTML += `
      <div class="item-box">
        <p><strong>${p.name}</strong></p>
        <p>â‚¹ ${p.price}</p>
        <p>Stock: ${p.stock}</p>
        <img class="product-img" src="${p.image_url}" />
        <br/>
        <button onclick="deleteProduct(${p.id})">Delete</button>
      </div>
    `;
  });
}

// ================= DELETE PRODUCT =================

async function deleteProduct(id) {
  await fetch(`/api/admin/products/${id}`, {
    method: "DELETE",
    headers: { "Authorization": token }
  });

  alert("Product deleted");
  loadProducts();
}

// ================= LOAD ORDERS =================

async function loadOrders() {
  const res = await fetch("/api/admin/orders", {
    headers: { "Authorization": token }
  });

  const orders = await res.json();
  const container = document.getElementById("orders");
  container.innerHTML = "";

  orders.forEach(order => {
    container.innerHTML += `
      <div class="item-box">
        <p><strong>Order ID:</strong> ${order.id}</p>
        <p>Total: â‚¹ ${order.total_amount}</p>
        <p>Status: ${order.status}</p>

        <select id="status-${order.id}">
          <option value="Pending">Pending</option>
          <option value="Shipped">Shipped</option>
          <option value="Delivered">Delivered</option>
        </select>

        <button onclick="updateStatus(${order.id})">Update</button>
      </div>
    `;
  });
}

// ================= UPDATE ORDER STATUS =================

async function updateStatus(id) {
  const status = document.getElementById(`status-${id}`).value;

  await fetch(`/api/admin/orders/${id}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": token
    },
    body: JSON.stringify({ status })
  });

  alert("Order updated");
  loadOrders();
}

// INITIAL LOAD
loadProducts();
loadOrders();

</script>

</body>
</html>
